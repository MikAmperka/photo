# Девчёнкам нравятся Big Clocks
## Месяц самоизоляции не прошел зря.

За время карантина многие наконец разобрали весь тот хлам, что хранился на балконах, антресолях и шкафах.
Так, я раскопал, непонятно от куда взявшуюся, зеленую светодиодную ленту и остатки картонных упаковок из Икеи.

И вот что из этого получилось.
<cut />

Что подсвечивать зеленой лентой? Непонятно.
Зато, она отлично подойдёт для светодиодной индикации.

И тут первое, что приходит в голову - собрать семисигментный индикатор и сделать из этого всего Большие Часы.
Моего картона должно хватить на четыре 32 см индикатора. Не Биг Бэн, как у Королевы, но всё же.

## Что для этого понадобится
### Материалы:
-   Картон;
-   Светодиодная лента, 12 В;
-   Листы бумаги 80 г/м2;
-   Клей карандаш;
-   Провода;
-   Контроллер вроде Ардуино;
-   4 х Octofet (сборка из 8-ми MOSFET транзисторов);
-   Блок питания 12В;

### Инструменты:
-   Канцелярский нож;
-   Ножницы;
-   Кусачки;
-   Отвертка, шлицевая и крест;
-   Паяльник;
-   Провод USB;
-   Линейка;
-   Карандаш;

## Как собрать

Я как ниндзя разрезаю найденный картон канцелярским ножом.

![Cut body](https://github.com/tolikivanov/photo/raw/master/ninja-cut.gif)

На одну из сторон, теперь она будет тыльной, приклеил дополнительные "прямоугольнички" вырезанные из того же картона вдоль рёбер жесткости. Сквозь них пропущу провода.

![Add wire chanel](https://github.com/tolikivanov/photo/raw/master/Wire-chanel.jpg)

Для сегмента будущего индикатора отрезал 10 см отрезок светодиодной ленты и припаял к нему пару проводов. 

![Add wire](https://github.com/tolikivanov/photo/raw/master/led-wire.jpg)

Рассеивателем для отрезка ленты станет цилиндр, вырезанный и свёрнутый из обычных офисных листов А4, склеенных клеем карандашом. 

![Make cylinder](https://github.com/tolikivanov/photo/raw/master/cylinder.gif)

Бумага, картон. Получается очень эко-фрэндли. Мне нравится!

Теперь приклеим цилиндры к каркасу пропустив провода в отверстия.

![Join-cylinder](https://github.com/tolikivanov/photo/raw/master/join-cylinder.jpg)

После того, как все цилиндры приклеены, можно заняться кабель-менеджментом и спрятать все провода внутрь заранее подготовленных каналов.

![Cable-management](https://github.com/tolikivanov/photo/raw/master/cable-management.gif)

Торцы цилинров закрыл заглушками вырезанными всё из того же картона.

-- Фото заглушенных цилинров --

Тоже самое осталось провернуть ещё для 3-х цифр. Надеюсь успеть до конца карантина.


## Управление
### Проблема №1. Ток

Привычными индикаторами, каждый сегмент которых потребляет всего 20-30 мА мохно управлять напрямую контроллером. Например с входов-выходов популярной Atmega328P можно снять до 40 мА.

Один сегмент моего индикатора потребляет аж ххх мА. Для управления таким током, между пинами контроллера и каждым сегментом, дополнительно придется использовать транзисторы или реле, способные пропустить через себя ток в ххх мА.

--Фото транзистора и реле--

Реле шумно и громоздко, а силовые ключи на MOSFET транзисторах - кажется то, что нужно.

### Проблема №2. Контакты

Чтобы управлять одним индикатором понадобыться 7 выходов. Четыри индикатора - это уже 28, а ещё разделительная точка. Итого 29, а у Ардуино Уно выходов всего 20.

В готовых индикаторных сборках используют выходные сдвиговые регистры —  микросхемы для увеличения количества цифровых выходов. Он управляется тремя пинами, а на выходе даёт целых восемь. 

-- Фото индикатора с двух сторон --

### Проблема №3. Габариты

Учитывая всё вышесказанное - собираю схему на сдвиговом регистре и силовых ключах.

-- фото сборки на макетке --

И хоть я размахнулся с размер будущих часов, но собрать "такое" для каждого из 4-х индикаторов - это слишком.

### Решение

Гораздо более элегантным решением стал OctoFet - готовая сборка из сдвигового регистра и 8-ми полевиков, каждый из которых расчитан на напряжение до 30 вольт и может пропустить через себя до 3-х ампер. 

-- фото сборки на макетке и октофета --

## Подключение

Провода от каждого сегмента индикатора подключил к клеммникам выходов Octofet-а.

-- Схема подключения одного индикатора и точки --

А сам Octofet, чтоб не болтался, закрепил всё на той же картонке, которую я приклеил к индикатору, как основание.

-- фото октофета с обратной стороны --

Теперь соединю сборки силовых ключей в одну цепочку, подключю их к контроллеру Ардуино и добавлю модуль часов реального времени.

-- Схема подключения октофетов и часов к ардуино --

Для подключения модулей к Ардуино удобно использовать тройка шилд. С ним всё можно соединить с помощью трехпроводных шлейфов, как конструктор.

## Прошивка
Программировать контроллер будем через [Arduino IDE](http://wiki.amperka.ru/%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B8-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-arduino-ide).
Для работы с Octofet-ом и часами реального времени дополнительно скачал и установил пару библиотек. 

  - [Библиотека Octofet](https://github.com/amperka/AmperkaFet)
  - [Библиотека TroykaRTC](https://github.com/amperka/TroykaRTC)
  - [Как устанавливать библиотеки в Arduino IDE](http://wiki.amperka.ru/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5:%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8#%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8)

### Исходный код
```cpp
// Ignore this for now. The definition is required by XOD but we
// not use it for cos
struct State { };

// This is an obligatory marker. XOD will put pin definitions there
\{{ GENERATED_CODE }}

// The `evaluate` function is the node’s entry point. It is the only
// function XOD requires to implement. The context parameter is a
// black-box object you’ll pass to various API functions.
void evaluate(Context ctx) {
    // `getValue` function reads a pin. In angle brackets, it takes a
    // name of the pin in form input_PINLABEL (input_RAD in our case)
    Number x = getValue<input_RAD>(ctx);

    // Next, we use regular C++ to perform some actions. Our case is trivial.
    // All we have to do is to call the standard C++ cos function.
    // Note the data type `Number`. It’s the type XOD uses to represent numbers
    // on the current platform.
    Number result = cos(x);

    // `emitValue` is like `getValue`, but it writes values rather than read.
    // Note we use `OUT` label to access our unlabeled output terminal.
    // `OUT` is the default name when you omit the label.
    emitValue<output_OUT>(ctx, result);
}
```
